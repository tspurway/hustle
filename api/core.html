<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>hustle.core.marble – The Hustle Database Core &mdash; Hustle 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Hustle 0.1 documentation" href="../index.html" />
    <link rel="prev" title="hustle – Hustle Distributed OLAP Database" href="hustle.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-48426035-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hustle.html" title="hustle – Hustle Distributed OLAP Database"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Hustle 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/hustle.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="hustle.html"
                        title="previous chapter"><tt class="docutils literal"><span class="pre">hustle</span></tt> &#8211; Hustle Distributed OLAP Database</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/api/core.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="module-hustle.core.marble"></span><div class="section" id="hustle-core-marble-the-hustle-database-core">
<h1><a class="reference internal" href="#module-hustle.core.marble" title="hustle.core.marble"><tt class="xref py py-mod docutils literal"><span class="pre">hustle.core.marble</span></tt></a> &#8211; The Hustle Database Core<a class="headerlink" href="#hustle-core-marble-the-hustle-database-core" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="hustle.core.marble.Marble">
<em class="property">class </em><tt class="descclassname">hustle.core.marble.</tt><tt class="descname">Marble</tt><big>(</big><em>name=None</em>, <em>fields=()</em>, <em>partition=None</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Marble" title="Permalink to this definition">¶</a></dt>
<dd><p>The Marble is the smallest unit of distribution and replication in Hustle.  The Marble is a wrapper around a
standalone <a class="reference external" href="http://symas.com/mdb/">LMDB</a> key/value store.  An <em>LMDB</em> key/value store may have many sub key/value
stores, which are called DBs in LMDB terminology.  Each Hustle column is represented by one LMDB DB (called the column
DB), plus another LMDB DB if that column is indexed (called the index DB) (see <a class="reference internal" href="../howto/schema.html#schemadesign"><em>Hustle Schema Design Guide</em></a>).</p>
<p>The Marble file is also the unit of insertion and replication of data into the Hustle system.  Marbles can be built
on remote systems, in a completely distributed manner.  They are then <em>pushed</em> into the cluster&#8217;s DDFS file system,
which is a relatively inexpensive operation.  This is Hustle&#8217;s <a class="reference internal" href="../howto/insert.html#insertguide"><em>distributed insert functionality</em></a>.</p>
<p>In addition each Marble contains several LMDB meta DBs for meta-data for prefix Tries, schema, and table statistics
used by the query optimizer.</p>
<p>The column DB is a key/value store that stores data for a particular column.  It has a locally unique row identifier (RID) as
the key, and the actual value for that column&#8217;s data as its value, encoded depending on the schema data type of
the column.  All integer types are directly encoded in LMDB as integers, whereas the Trie compression types are encoded
as integers (called VIDs), which actually are keys in the two dedicated Trie meta DBs (one for 32 and one for 16
bit Tries).  Uncompressed strings, as well as lz4 and binary style data is simply encoded as byte string values.</p>
<p>The index DB for a column is a key/value store that inverts the key and the value of the column DB.  It is used to
perform the identity and range queries required form Hustle&#8217;s <em>where clause</em>.  The key in the index DB is the
actual value for that column, but the value is a <em>bitmap index</em> of the RIDs where that value is present.  This is
a very efficient and compact way to store the index in an append-only database like Hustle.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>name</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#basestring" title="(in Python v2.7)"><em>basestring</em></a>) &#8211; the name of the <em>Marble</em> to create</li>
<li><strong>name</strong> &#8211; the schema specification of the columns (see <a class="reference internal" href="../howto/schema.html#schemadesign"><em>Hustle Schema Guide</em></a></li>
<li><strong>partition</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#basestring" title="(in Python v2.7)"><em>basestring</em></a>) &#8211; the column that will serve as the partition for this <em>Marble</em></li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="classmethod">
<dt id="hustle.core.marble.Marble.from_file">
<em class="property">classmethod </em><tt class="descname">from_file</tt><big>(</big><em>filename</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Marble.from_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Instantiate a <a class="reference internal" href="#hustle.core.marble.Marble" title="hustle.core.marble.Marble"><tt class="xref py py-class docutils literal"><span class="pre">Marble</span></tt></a> from an <em>LMDB</em></p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="hustle.core.marble.Column">
<em class="property">class </em><tt class="descclassname">hustle.core.marble.</tt><tt class="descname">Column</tt><big>(</big><em>name</em>, <em>table</em>, <em>index_indicator=0</em>, <em>partition=False</em>, <em>type_indicator=0</em>, <em>compression_indicator=0</em>, <em>rtrie_indicator=2</em>, <em>alias=None</em>, <em>boolean=False</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Column" title="Permalink to this definition">¶</a></dt>
<dd><p>A <em>Column</em> is the named, typed field of a <a class="reference internal" href="#hustle.core.marble.Marble" title="hustle.core.marble.Marble"><tt class="xref py py-class docutils literal"><span class="pre">Marble</span></tt></a>.   <em>Columns</em> are typically
created automatically by parsing the <em>fields</em> of a the <em>Marble</em> instantiation.</p>
<p>The <em>Column</em> overrides Python&#8217;s relational operators <tt class="code docutils literal"><span class="pre">&gt;</span> <span class="pre">&lt;</span> <span class="pre">&lt;=</span> <span class="pre">&gt;=</span> <span class="pre">==</span></tt> which forms the basis for
the <a class="reference internal" href="../howto/query.html#queryguide"><em>Query DSL</em></a>.  All of these operators expect a <em>Python literal</em> as their second
(right hand side) argument which should be the same type as the <em>Column</em>.  These <em>Column Expressions</em> are
represented by the <a class="reference internal" href="#hustle.core.marble.Expr" title="hustle.core.marble.Expr"><tt class="xref py py-class docutils literal"><span class="pre">Expr</span></tt></a> class.</p>
<p>Note that the <em>Marble</em> and <em>Table</em> classes expose their <em>Columns</em> as Python <em>attributes</em>:</p>
<div class="highlight-python"><div class="highlight"><pre># instantiate a table
imps = Table.from_tag(&#39;impressions&#39;)

# access a the date column
date_column = imps.date

# create a Column Expression
site_column_expression = imps.site_id == &#39;google.com&#39;

# create another Column Expression
date_column_expression = date_column &gt; &#39;2014-03-07&#39;

# query
select(date_column, where=date_column_expression &amp; )
</pre></div>
</div>
<dl class="method">
<dt id="hustle.core.marble.Column.named">
<tt class="descname">named</tt><big>(</big><em>alias</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Column.named" title="Permalink to this definition">¶</a></dt>
<dd><p>return a new column that has an alias that will be used in the resulting schema
:type alias: str
:param alias: the name of the alias</p>
</dd></dl>

<dl class="method">
<dt id="hustle.core.marble.Column.schema_string">
<tt class="descname">schema_string</tt><big>(</big><big>)</big><a class="headerlink" href="#hustle.core.marble.Column.schema_string" title="Permalink to this definition">¶</a></dt>
<dd><p>return the schema for this column.  This is used to build the schema of a query
result, so we need to use the alias.</p>
</dd></dl>

<dl class="method">
<dt id="hustle.core.marble.Column.description">
<tt class="descname">description</tt><big>(</big><big>)</big><a class="headerlink" href="#hustle.core.marble.Column.description" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a human-readable type description for this column.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="hustle.core.marble.Aggregation">
<em class="property">class </em><tt class="descclassname">hustle.core.marble.</tt><tt class="descname">Aggregation</tt><big>(</big><em>name</em>, <em>column</em>, <em>f=None</em>, <em>g=&lt;function &lt;lambda&gt; at 0x1101e9c08&gt;</em>, <em>h=&lt;function &lt;lambda&gt; at 0x1101e9c80&gt;</em>, <em>default=&lt;function &lt;lambda&gt; at 0x1101e9cf8&gt;</em>, <em>is_numeric=None</em>, <em>is_binary=None</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Aggregation" title="Permalink to this definition">¶</a></dt>
<dd><p>An <em>Aggregation</em> is a Column Function that represents some aggregating computation over the values of that
column.  It is exclusively used in the <em>project</em> section of the <a class="reference internal" href="hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">select()</span></tt></a> function.</p>
<p>An <em>Aggregation</em> object holds onto four distinct function references which are called at specific times
during the <em>group_by stage</em> of the query pipeline.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>f</strong> (<em>func(accumulator, value)</em>) &#8211; the function called for every value of the <em>column</em>, returns a new accumulator (the MAP aggregator)</li>
<li><strong>g</strong> (<em>func(accumulator)</em>) &#8211; the function called to produce the final value (the REDUCE aggregator)</li>
<li><strong>h</strong> (<em>func(accumulator)</em>) &#8211; the function called to produce intermediate values (the COMBINE aggregator)</li>
<li><strong>default</strong> (<em>func()</em>) &#8211; the function called to produce the initial aggregation accumulator</li>
<li><strong>column</strong> (<a class="reference internal" href="#hustle.core.marble.Column" title="hustle.core.marble.Column"><tt class="xref py py-class docutils literal"><span class="pre">Column</span></tt></a>) &#8211; the column to aggregate</li>
<li><strong>name</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#basestring" title="(in Python v2.7)"><em>basestring</em></a>) &#8211; the unique name of the aggregator.  Used to assign a column name to the result</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Here is the actual implementation of the h_avg() <em>Aggregation</em> which will give us the average value
for a numeric column in a <a class="reference internal" href="hustle.html#hustle.select" title="hustle.select"><tt class="xref py py-func docutils literal"><span class="pre">select()</span></tt></a> statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">h_avg</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Aggregation</span><span class="p">(</span><span class="s">&quot;avg&quot;</span><span class="p">,</span>
                       <span class="n">col</span><span class="p">,</span>
                       <span class="n">f</span><span class="o">=</span><span class="k">lambda</span> <span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">val</span><span class="p">:</span> <span class="p">(</span><span class="n">accum</span> <span class="o">+</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                       <span class="n">g</span><span class="o">=</span><span class="k">lambda</span> <span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span> <span class="nb">float</span><span class="p">(</span><span class="n">accum</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="p">,</span>
                       <span class="n">h</span><span class="o">=</span><span class="k">lambda</span> <span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span> <span class="p">(</span><span class="n">accum</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
                       <span class="n">default</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>First look at the <em>default()</em> function which returns the tuple (0, 0).  This sets the <em>accum</em> and <em>count</em> values
that we will be tracking both to zero.  Next, let&#8217;s see what&#8217;s happening in the <em>f()</em> function.  Note that it
performs two computations, one <tt class="code docutils literal"><span class="pre">accum</span> <span class="pre">+</span> <span class="pre">val</span></tt> builds a sum of the values, and the <tt class="code docutils literal"><span class="pre">count</span> <span class="pre">+</span> <span class="pre">1</span></tt> will
count the total number of values.  The difference between the <em>g()</em> and <em>h()</em> functions is when they take place.
The <em>h()</em> function is used to summarize results.  It should always return an <em>accum</em> that can be further
inputted into the <em>f()</em> function.  The <em>g()</em> function is used at the very end of the computation to compute the
final value to return the client.</p>
<p>Note that most aggreations are much simpler than <a class="reference internal" href="hustle.html#hustle.h_avg" title="hustle.h_avg"><tt class="xref py py-func docutils literal"><span class="pre">h_avg()</span></tt></a>.  Consider the implementation
for <a class="reference internal" href="hustle.html#hustle.h_sum" title="hustle.h_sum"><tt class="xref py py-func docutils literal"><span class="pre">h_sum()</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre>def h_sum(col):
    return Aggregation(&quot;sum&quot;,
                       col,
                       f=lambda accum, val: accum + val
                       default=0)
</pre></div>
</div>
<p class="last">We don&#8217;t have to implement the <tt class="code docutils literal"><span class="pre">h()</span> <span class="pre">or</span> <span class="pre">g()</span></tt> functions, as they simply default to funcitons that
return the <tt class="code docutils literal"><span class="pre">accum</span></tt>, which is normally sufficient.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="hustle.html#hustle.h_sum" title="hustle.h_sum"><tt class="xref py py-func docutils literal"><span class="pre">h_sum()</span></tt></a>, <a class="reference internal" href="hustle.html#hustle.h_count" title="hustle.h_count"><tt class="xref py py-func docutils literal"><span class="pre">h_count()</span></tt></a>, <a class="reference internal" href="hustle.html#hustle.h_avg" title="hustle.h_avg"><tt class="xref py py-func docutils literal"><span class="pre">h_avg()</span></tt></a></dt>
<dd>Some of Hustle&#8217;s aggregation functions</dd>
</dl>
</div>
</dd></dl>

<dl class="class">
<dt id="hustle.core.marble.Expr">
<em class="property">class </em><tt class="descclassname">hustle.core.marble.</tt><tt class="descname">Expr</tt><big>(</big><em>table</em>, <em>f=None</em>, <em>part_f=None</em>, <em>is_partition=False</em><big>)</big><a class="headerlink" href="#hustle.core.marble.Expr" title="Permalink to this definition">¶</a></dt>
<dd><p>The <em>Expr</em> is returned by the overloaded relational operators of the <a class="reference internal" href="#hustle.core.marble.Column" title="hustle.core.marble.Column"><tt class="xref py py-class docutils literal"><span class="pre">Column</span></tt></a>
class.</p>
<p>The <em>Expr</em> is a recursive class, that can be composed of other <em>Exprs</em> all connected with the logical
<tt class="code docutils literal"><span class="pre">&amp;</span> <span class="pre">|</span> <span class="pre">~</span></tt> operators (<em>and, or, not</em>).</p>
<p>Each <em>Expr</em> instance must be aware if its sub-expressions <em>have</em> partitions or <em>are</em> partitions.  This is to
because the <em>&amp;</em> and <em>|</em> operators will optimize expressions over patitioned columns differently.  Consider the
following query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="s">&#39;2014-02-20&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Let&#8217;s assume that the <em>impressions.date</em> column is a partition column.  It should be clear that we can optimize
this query by only executing the query on the &#8216;2014-02-20&#8217; partition, which if we had many dates would vastly
improve our query execution.</p>
<p>On the other hand consider the following, almost identical query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">select</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">date</span> <span class="o">==</span> <span class="s">&#39;2014-02-20&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">impressions</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>In this case, we cannot optimize according to our partition.  We need to visit <em>all</em> partitions in <em>impressions</em>
and execute the <em>OR</em> operation across those rows for the <em>amount</em> expression.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is important to realize that all Column Expressions in an Expr must refer to the same <em>Table</em></p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>table</strong> (<a class="reference internal" href="hustle.html#hustle.Table" title="hustle.Table"><tt class="xref py py-class docutils literal"><span class="pre">Table</span></tt></a>) &#8211; the <em>Table</em> this <em>Expr</em> queries</li>
<li><strong>f</strong> (<em>func(MarbleStream)</em>) &#8211; the function to execute to actually perform the expression on data in the <em>Marble</em></li>
<li><strong>part_f</strong> (<em>func(list of strings)</em>) &#8211; the function to execute to perform the expresson on data in the <em>partition</em></li>
<li><strong>is_partition</strong> (<a class="reference external" href="http://docs.python.org/library/functions.html#bool" title="(in Python v2.7)"><em>bool</em></a>) &#8211; indicates if this Expr only has partition columns</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="hustle.core.marble.check_query">
<tt class="descclassname">hustle.core.marble.</tt><tt class="descname">check_query</tt><big>(</big><em>select</em>, <em>join</em>, <em>order_by</em>, <em>limit</em>, <em>wheres</em><big>)</big><a class="headerlink" href="#hustle.core.marble.check_query" title="Permalink to this definition">¶</a></dt>
<dd><p>Query checker for hustle.</p>
</dd></dl>

</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hustle.html" title="hustle – Hustle Distributed OLAP Database"
             >previous</a> |</li>
        <li><a href="../index.html">Hustle 0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2014, Tim Spurway.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.1.
    </div>
<div class="footer">
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>